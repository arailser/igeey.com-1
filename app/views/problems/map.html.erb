<% @title = '地图'%>

<% content_for :head do %>
  <script type="text/javascript" src="http://ditu.google.cn/maps/api/js?sensor=false"></script>
<% end %>

<div>
  <h4>地点位置</h4>
  <div id="map_canvas" style="height:360px;clear:both;margin:10px 0"></div>
</div>

<% content_for :sidebar do %>
  <div id="kase_box">
  </div>
<% end %>

<% content_for :extension do %>
  <script type="text/javascript">
    function initialize() {
      var kases = <%= raw @kases.to_json %>;
      var latlng = new google.maps.LatLng(35.0,105.0)
      var myOptions = {
        zoom: 4,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
      geocoder = new google.maps.Geocoder();
      markers = new Array
      
      $.each(kases, function(i,item){
          markers[i] = new google.maps.Marker({
            icon: "/images/marker/kase.png",
            position: new google.maps.LatLng(parseFloat(item.kase.latitude), parseFloat(item.kase.longitude)),
            title: item.kase.intro,
            map: map
          });
          google.maps.event.addListener(markers[i], "click", function(){
            $.ajax({
              url:"/problems/<%= @problem.id %>/kases/" + item.kase.id + ".xml",
              success:function(data, textStatus, XMLHttpRequest){$('#kase_box').html(data.documentElement)},
              dataType:'xml'
          })
        })
      });
    }; //initialize_end()
    
    $(document).ready(function(){
        initialize();
        $('#locate').submit(function(){geocoding($('#address').attr('value'))})
      });  
  </script>
<% end %>
