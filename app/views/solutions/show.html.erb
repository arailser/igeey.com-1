<% @title = "解决方案-#{@solution.title}"%>

<div class="box">
  <h1><%= @solution.title %></h1>
  <div id="tabContaier">
    <ul id="tabNav">
      <li><%= link_to '首页',"#index"%></li>
      <li><%= link_to '日记',"#blogs"%></li>
      <li><%= link_to '具体做法',"#steps"%></li>
      <li><%= link_to '讨论区',"#discussions"%></li>
      <li><%= link_to '下载',"#downloads"%>
    </ul>
    <div id='index' class="tabContents">      
      <h4>简介</h4>
      <%= raw @solution.intro %>
      <br/>
      <div style="text-align:right;" class="box">
        <%= render :partial => '/public/share'%>
      </div>
      <% if @solution.managed_by?(current_user)%>
        <div style="text-align:right">
          <span>
            <%= link_to "编辑","#{edit_solution_path(@solution)}?back_path=#{request.path}"%>
          </span>
        </div>
      <% end %>
    </div>
    
    <div id='blogs' class="tabContents">
      <h4>
        <%= @solution.title%>的日记
        <% if @solution.managed_by?(current_user)%>
          <span>(<%= link_to "添加新日记", new_solution_blog_path(@solution)%>)</span>
        <% end %>
      </h4>
      <% @blogs.each do |blog| %>
        <div style="margin:30px 0;">
          <%= link_to blog.title, solution_blog_path(@solution,blog)%><br/>
          <div style="margin:5px 0;"><span><%= full_date(blog.created_at)%></span></div>
          <%= raw short_text(blog.content.gsub(/<.*?>/,''),200) %>
        </div>
      <% end %>
    </div>
    
    <div id='steps' class="tabContents">
      <%= raw @solution.usage %>
      <br/>
      <h4>标签</h4>
      <%= raw tag_list_for(@solution.tag_list)%>
      <% if @solution.managed_by?(current_user)%>
        <div style="text-align:right">
          <span>
            <%= link_to "编辑","#{edit_solution_path(@solution)}?back_path=#{request.path}"%>
          </span>
        </div>
      <% end %>
    </div>
    
    <div id='discussions' class="tabContents">
      <% if @posts.empty? %>
        <span>还没有内容，您可以 <%= link_to '第一个在讨论区里发言', new_solution_post_path(@solution)%></span>
      <% else %>
        <div style="text-align:right;margin-bottom:10px;"><%= link_to '添加新话题', new_solution_post_path(@solution)%></div>
        <table style="font-size:13px;width:610px;" cellpadding=3 >
          <tr>
            <th style="width:57%;" align="left" >话题</th>
            <th style="width:15%;" align="left" >作者</th>
            <th style="width:9%;" align="left" >回应</th>
            <th style="width:19%;" align="right" >更新时间</th>
          </tr>
          <% @posts.each do |p| %>
            <tr>
              <td><%= link_to p.title, solution_post_path(@solution, p) %></td>
              <td><%= link_to p.user.login,user_path(p.user)%></td>
              <td><%= p.comments_count%></td>
              <td><%= full_date(p.last_replied_at)%></td>
            </tr>
          <% end %>
        </table>
      <% end %>
    </div>
    
    <div id='downloads' class="tabContents">
      <% if @solution.managed_by?(current_user)%>
        <div style="text-align:right">
          <span>
            <%= link_to "添加下载内容","#{new_solution_download_path(@solution)}?back_path=#{request.path}"%>
          </span>
        </div>
      <% end %>
      <table width = "610" border="0" cellpadding="3" cellspacing="1" bgcolor="#000000">
        <thead bgcolor="#ced9e5">
          <tr>
            <th style="width:50%;">名字</th>
            <th style="width:30%;">发布时间</th>
            <% if @solution.managed_by?(current_user)%>
              <th style="width:10%;">下载</th>
              <th style="width:10%;">管理</th>
            <% else %>
              <th style="width:20%;">下载</th>
            <% end %>
          </tr>
        </thead>
        <tbody bgcolor="#ffffff">
          <% @downloads.each do |download|%>
          <tr align="center">
            <td><%= download.title%></td>
            <td><%= full_date(download.created_at)%></td>
            <td><%= link_to '下载', download.download.url%></td>
            <% if @solution.managed_by?(current_user)%>
              <td><%= link_to "删除", solution_download_path(@solution, download),:method => :delete,:confirm => "你确定要删除#{download.title}吗？"%></td>
            <% end %>
          </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<% content_for :sidebar do %>  
  <div class="box"><%= raw(follow_to(@solution)) %></div>
  
  <% unless @following_users.empty? %>
    <div class="box">
      <h5><%= image_tag '/images/icon/eye.png',:class => 'icon'%> 关心这个项目的同学：</h5>
      <% @following_users.each do |user|%>
        <%= link_to (image_tag user.avatar.url,:class => "small_avatar",:alt => user.login),user_path(user),:title => user.login %>
      <% end %>
    </div>
  <% end %>
  
  <% if @solution.managed_by?(current_user)%>
    <% unless @managers.empty? %>
      <div class="box">
        <h4>管理员名单</h4>
        <% if current_user.is_admin?%>
          <% @managers.each do |user|%>
            <%= link_to (image_tag user.avatar.url,:class => "small_avatar",:alt => user.login),user_path(user),:title => user.login %><%= link_to "x", solution_management_path(@solution, @solution.managements.find_by_user_id(user.id)),:method => :delete,:confirm => "你确定要撤销#{user.login}的管理权限吗？"%>
          <% end %>
        <% else%>
          <% @managers.each do |user|%>
            <%= link_to (image_tag user.avatar.url,:class => "small_avatar",:alt => user.login),user_path(user),:title => user.login %>
          <% end %>
        <% end %>
      </div>
    <% end %>
    <div class="box">
      <h4>添加管理员</h4>
      <%= form_for [@solution,@management] do |form| %>
          <%= form.label :user_id,'用户编号：' %>
          <%= form.text_field :user_id,:size => 4 %>
          <%= form.submit '确定'%>
      <% end %>
    </div>
  <% end %>
<% end %>